<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Configuración de codificación y diseño responsive -->
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>

    <!-- Título del documento -->
    <title>ReadIt Club</title>

    <!-- Favicon -->
    <link rel="icon" href="images/logo.png">

    <!-- Importación de estilos y fuentes externas -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
    
    <!-- Biblioteca para alertas -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Estilos personalizados -->
    <link href="styles.css" rel="stylesheet">

    <!-- Script para verificar si el token JWT ha expirado -->
    <script>
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp;
                if (!exp) return true;
                const now = Math.floor(Date.now() / 1000);
                return now >= exp;
            } catch (e) {
                return true;
            }
        }

        // Decodifica el token JWT para obtener los datos del usuario
        function decodeToken(token) {
            if (!token) return null;
            try {
                const payloadBase64 = token.split('.')[1];
                const payloadJson = atob(payloadBase64);
                return JSON.parse(payloadJson);
            } catch (e) {
                console.error('Error decoding token:', e);
                return null;
            }
        }

        let tokenData;
        let rol;

        // Validación de sesión al cargar el documento
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            if (!token || isTokenExpired(token)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sesión expirada',
                    text: 'Por favor, inicia sesión de nuevo.',
                    confirmButtonText: 'Ir a iniciar sesión'
                }).then(() => {
                    window.location.href = 'signing.html';
                });
                return;
            }

            // Mostrar imagen de perfil si existe en el token
            let img = document.getElementById('imgperfil');
            tokenData = decodeToken(token);
            if (tokenData && tokenData.picture) {
                img.src = tokenData.picture;
            }
        });
    </script>

    <!-- Script para manejo de secciones y menús -->
    <script>
        // Alternar entre pestañas principales
        function showSection(sectionId, tabId) {
            document.getElementById('informacion').style.display = 'none';
            document.getElementById('lecturas').style.display = 'none';
            document.getElementById('seccionEventos').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';

            document.getElementById('tab-informacion').classList.remove('active-tab');
            document.getElementById('tab-lecturas').classList.remove('active-tab');
            document.getElementById('tab-eventos').classList.remove('active-tab');
            document.getElementById(tabId).classList.add('active-tab');
        }

        // Alternar entre subtabs de lecturas
        function showSection2(sectionId, tabId) {
            document.getElementById('libro-curso').style.display = 'none';
            document.getElementById('proxima-lectura').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';

            document.getElementById('tab-libro-curso').classList.remove('active-tab');
            document.getElementById('tab-proxima-lectura').classList.remove('active-tab');
            document.getElementById(tabId).classList.add('active-tab');
        }

        // Muestra u oculta campos según el tipo de evento seleccionado
        function toggleEvento() {
            let tipoEvento = document.getElementById("tipoEvento").value;
            let campoVirtual = document.getElementById("campoVirtual");
            let campoPresencial = document.getElementById("campoPresencial");

            if (tipoEvento === "virtual") {
                campoVirtual.classList.remove("d-none");
                campoPresencial.classList.add("d-none");
            } else {
                campoVirtual.classList.add("d-none");
                campoPresencial.classList.remove("d-none");
            }
        }

        // Mostrar u ocultar menú de perfil
        function toggleProfileMenu() {
            let menu = document.getElementById('profile-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Mostrar u ocultar menú de notificaciones
        function toggleNotificationMenu() {
            let menu = document.getElementById('notification-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Mostrar u ocultar menú de opciones específicas por ID
        function toggleOptionsMenu(menuId) {
            const menu = document.getElementById(menuId);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Mostrar un modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Ocultar un modal
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Redirigir a la página principal del club
        function goToClubPage() {
            window.location.href = 'club.html';
        }

        // Guardar libro seleccionado y redirigir a discusión
        function goToDiscussion(libroId) {
            localStorage.setItem('selectedLibroId', libroId);
            window.location.href = 'discusion.html';
        }
    </script>
</head>

<body class="bg-light">
<!-- ENCABEZADO -->
<header class="bg-warning p-4 d-flex justify-content-between align-items-center" style="height: 13vh; position: relative; z-index: 10;">
    <a href="main.html">
        <div class="d-flex align-items-center">
            <img alt="Logo" class="rounded-circle" height="45vh" src="images/logo.png" />
            <h1 class="text-dark font-weight-bold ml-0" style="font-size: 5vh;">Read-It</h1>
        </div>
    </a>  

    <!-- Perfil del usuario con menú desplegable -->
    <div class="d-flex justify-content-between align-items-center mb-3">   
        <div class="profile-container d-flex align-items-center" onclick="toggleProfileMenu()">
            <img id="imgperfil" src="images/fotoperfil.jpg" alt="Perfil" class="rounded-circle" style="width: 6vh; object-fit: cover; cursor: pointer;">
            <i id="profile-arrow" class="fas fa-chevron-down text-dark ml-2"></i>
            <div id="profile-menu" class="profile-menu">
                <a href="myprofile.html">Mi perfil</a>
                <a href="#" onclick="logout()">Cerrar sesión</a>
            </div>
        </div>
    </div>
</header>

<!-- Separador visual -->
<div class="d-flex align-items-center bg-primary" style="height: 5px;"></div>

<!-- Imagen del banner del club -->
<img alt="Club Romántica" class="card-img-top club-banner" src="https://storage.googleapis.com/a1aa/image/zrtnSTdJfTjgSJ6YfnlvKs-GNyU8JoToDo1kETZvyK4.jpg"/>

<!-- Nombre del club dinámico -->
<div class="d-flex justify-content-center align-items-center bg-primary px-3 py-2">
  <h2 class="text-white font-weight-bold text-center" id="NombreClub"
      style="font-size: 6vh; word-break: break-word; overflow-wrap: break-word; white-space: normal;">
  </h2>
</div>

<div class="container-fluid">
  <div class="row align-items-center">
    <!-- Sección izquierda: muestra el género literario del club -->
    <div class="col-6">
      <h6 class="text-dark font-weight-bold ml-2" style="margin-top: 10px;">Género literario del club: </h6>
      <h4 class="text-dark font-weight-bold ml-2" id="genero"></h4> <!-- Aquí se insertará dinámicamente el género -->
    </div>

    <!-- Sección derecha: botones para unirse, editar o eliminar el club -->
    <div class="col-6 d-flex justify-content-end align-items-center flex-wrap mt-3">
        <!-- Botón para unirse o salir del club (visible según el rol del usuario) -->
        <button class="btn btn-primary join-btn" onclick="toggleMembership(this)" id="Miembro" style="display: none;">Unirse al Club</button>
        
        <!-- Botón visible solo para administradores: permite editar el club -->
        <button class="btn btn-primary join-btn" onclick="mostrarModalEditar()" id="btn-admin" style="display: none;">Editar Club</button>
        
        <!-- Botón visible solo para administradores: permite eliminar el club -->
        <button class="btn btn-danger join-btn" onclick="confirmDeleteClub()" id="btn-delete" style="display: none; margin-left: 10px;">Eliminar Club</button>

        <script>
        // Obtener el token JWT del almacenamiento local
        const token = localStorage.getItem('jwtToken');
        tokenData = decodeToken(token); // Decodificar token para obtener datos del usuario

        // Obtener ID del club desde la URL o del sessionStorage
        const params = new URLSearchParams(window.location.search);
        club = params.get("_id") || sessionStorage.getItem('selectedClub');

        // Consultar el rol del usuario en el club (none, member o admin)
        fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/rol`)
            .then(response => response.json())
            .then(data => {
                const rol = data.role;

                // Si no pertenece al club
                if (rol === 'none') {
                    const miembroElem = document.getElementById("Miembro");
                    const votacion = document.getElementById("voteButtons");
                    votacion.style.display = "none"; // Ocultar votación
                    miembroElem.style.display = "block"; // Mostrar botón de unirse
                    miembroElem.classList.remove("btn-primary");
                    miembroElem.classList.add("btn-success");
                    miembroElem.textContent = "Unirse al club";

                    // Acción al hacer clic en "Unirse al club"
                    miembroElem.onclick = () => {
                        fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/add-miembro`, {
                            method: 'POST',
                        })
                        .then(response => {
                            if (response.ok) {
                                // Añadir insignia al usuario al unirse
                                fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/usuarios/${tokenData.id}/insignia/680e4e964d4e9715973c6ac8/add`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                });
                                // Confirmación de éxito
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Éxito!',
                                    text: 'Te has unido al club.',
                                    timer: 3000,
                                    confirmButtonText: 'Aceptar'
                                }).then(() => {
                                    location.reload(); // Recargar la página
                                });
                            } else {
                                // Error al unirse
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    timer: 3000,
                                    text: 'Error al unirse al club.',
                                });
                            }
                        })
                        .catch(() => {
                            // Error de red al unirse
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                timer: 3000,
                                text: 'Error al unirse al club. Verifica tu conexión.',
                            });
                        });
                    };
                }
                // Si ya es miembro del club
                else if (rol === 'member') {
                    const miembroElem = document.getElementById("Miembro");
                    miembroElem.style.display = "block";
                    miembroElem.classList.add("btn-primary");
                    miembroElem.classList.remove("btn-success");
                    miembroElem.textContent = "Salir del club";

                    // Acción al hacer clic en "Salir del club"
                    miembroElem.onclick = () => {
                        fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/remove-miembro`, {
                            method: 'DELETE',
                        })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Has salido del club',
                                    text: 'Esperamos verte de nuevo pronto.',
                                    timer: 4000,
                                    confirmButtonText: 'Aceptar'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    timer: 5000,
                                    text: 'No se pudo salir del club.',
                                });
                            }
                        })
                        .catch(() => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de red',
                                timer: 5000,
                                text: 'Ocurrió un problema al intentar salir del club.',
                            });
                        });
                    };
                }
                // Si es administrador del club
                else if (rol === 'admin') {
                    const adminElem = document.getElementById("btn-admin");
                    const deleteElem = document.getElementById("btn-delete");
                    const libro = document.getElementById("subirLibro");
                    const evento = document.getElementById("crearEvento");
                    const votacion = document.getElementById("crearVotacion");

                    // Mostrar botones de administración
                    adminElem.style.display = "block";
                    deleteElem.style.display = "block";
                    libro.style.display = "block";
                    evento.style.display = "block";
                    votacion.style.display = "block";

                    // Asociar eventos a los botones
                    adminElem.onclick = () => mostrarModalEditar();
                    deleteElem.onclick = () => confirmDeleteClub();
                }
            });

        // Confirmación para eliminar el club (modal de advertencia)
        function confirmDeleteClub() {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción eliminará el club permanentemente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteClub(); // Si se confirma, llama a la función para eliminar
                }
            });
        }

        // Función que elimina el club desde la API
        async function deleteClub() {
            try {
                const token = localStorage.getItem('jwtToken');
                const response = await fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/clubes/${encodeURIComponent(clubActual._id)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Club eliminado',
                        text: 'El club ha sido eliminado exitosamente.',
                        timer: 3000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'main.html'; // Redirigir al inicio
                    });
                } else {
                    const errorData = await response.json();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorData.message || 'No se pudo eliminar el club.'
                    });
                }
            } catch (error) {
                console.error('Error eliminando el club:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al eliminar el club.'
                });
            }
        }

        // Función para cerrar sesión
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'signing.html'; // Redirige al login
        }
      </script>
    </div>
  </div>
</div>

<!-- Barra de navegación principal del club -->
<nav class="bg-white shadow-sm" style="margin-top: 2vh;">
    <ul class="nav justify-content-right p-3">
        <!-- Opción de pestaña: Información del club -->
        <li class="nav-item">
            <a id="tab-informacion" class="nav-link text-warning active-tab" href="javascript:void(0);" onclick="showSection('informacion', 'tab-informacion')">Información</a>
        </li>
        <!-- Opción de pestaña: Lecturas del club -->
        <li class="nav-item">
            <a id="tab-lecturas" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection('lecturas', 'tab-lecturas')">Lecturas</a>
        </li>
        <!-- Opción de pestaña: Eventos del club -->
        <li class="nav-item">
          <a id="tab-eventos" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection('seccionEventos', 'tab-eventos')">Eventos</a>
        </li>
    </ul>
</nav>

<main class="p-4">
    <!-- Sección de información general del club -->
    <section id="informacion">
        <h2 class="font-weight-bold mb-3">Descripción</h2>
        <p class="text-muted"></p>
    
        <!-- Información sobre el administrador y número de miembros -->
        <section class="mt-5">
            <h2 class="font-weight-bold mb-3">Sobre el club</h2>
            <p class="mt-2" id="admin">Administrado por: <strong></strong></p>
            <p>Miembros: <strong id="memberCount"></strong></p>
        </section>
    </section>
    
    <!-- Sección de lecturas (oculta por defecto) -->
    <section id="lecturas" style="display: none;">
        <!-- Submenú de navegación para las lecturas -->
        <nav class="bg-white shadow-sm">
            <ul class="nav justify-content-right p-3">
                <!-- Libros que se están leyendo actualmente -->
                <li class="nav-item">
                    <a id="tab-libro-curso" class="nav-link text-warning active-tab" href="javascript:void(0);" onclick="showSection2('libro-curso', 'tab-libro-curso')">Libros en curso</a>
                </li>
                <!-- Votación para elegir la próxima lectura -->
                <li class="nav-item">
                    <a id="tab-proxima-lectura" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection2('proxima-lectura', 'tab-proxima-lectura')">Votación próxima lectura</a>
                </li>
            </ul>
        </nav>

        <!-- Subsección de libros en curso -->
        <section id="libro-curso">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="font-weight-bold">Lecturas del club</h3>
                <!-- Botón para subir nuevo libro (visible solo para admin) -->
                <button class="btn btn-success" onclick="showModal('modalSubirLibro')" id="subirLibro" style="display: none;">
                    <i class="fas fa-plus"></i> Subir libro
                </button>
            </div>
            <!-- Contenedor dinámico para mostrar los libros -->
            <div class="container mt-4" id="libros"></div>    
        </section>  

        <!-- Subsección de votación para la próxima lectura -->
        <section id="proxima-lectura" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="font-weight-bold">Votaciones del club en curso</h3>
                <!-- Botón para crear nueva votación (visible solo para admin) -->
                <button class="btn btn-success" onclick="showModal('modalCrearVotacion')" id="crearVotacion" style="display: none;">
                    <i class="fas fa-plus"></i> Crear votación
                </button>
            </div>

            <!-- Contenedor para el gráfico de barras de votación -->
            <div class="card text-center">
                <h5>Gráfico de votación entre títulos</h5>
                <div id="chart" class="bg-light border rounded p-3">
                    <div class="bar-container" id="barContainer">
                        <!-- Barras generadas dinámicamente con JS -->
                    </div>
                </div>

                <!-- Botones de votación generados dinámicamente -->
                <div class="vote-buttons" id="voteButtons"></div>
            </div>

            <!-- Mensaje de confirmación o error de voto -->
            <div class="mensaje" id="mensajeVoto"></div>
        </section>
    </section>
</main>

<!-- Modal para crear una nueva votación -->
<div class="modal" id="modalCrearVotacion" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <!-- Encabezado del modal -->
          <div class="modal-header">
              <h5 class="modal-title">Crear votación</h5>
              <button type="button" class="close" onclick="hideModal('modalCrearVotacion')" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          
          <!-- Cuerpo del modal con el formulario -->
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
              <form id="formCrearVotacion">
                <small class="form-text text-muted" style="text-align: right">* Todos los campos son obligatorios *</small>

                  <!-- Campo para ingresar días de votación -->
                  <div class="form-group">
                      <label for="diasVotacion">Días de votación</label>
                      <input type="text" class="form-control" id="diasVotacion" placeholder="Ingrese el número de días de votación" required>
                  </div>
                  <!-- Campo para ingresar el primer título -->
                  <div class="form-group">
                      <label for="titulo1">Título 1</label>
                      <input type="text" class="form-control" id="titulo1" placeholder="Ingrese el primer título" required>
                  </div>
                  <!-- Campo para ingresar el segundo título -->
                  <div class="form-group">
                      <label for="titulo2">Título 2</label>
                      <input type="text" class="form-control" id="titulo2" placeholder="Ingrese el segundo título" required>
                  </div>
                  <!-- Contenedor dinámico para más títulos -->
                  <div id="titulosAdicionales"></div>
                  <button type="button" class="btn btn-link" id="btnAgregarTitulo">Agregar otro título</button>
              </form>
          </div>

          <!-- Botones de acción del modal -->
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="hideModal('modalCrearVotacion')">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btnCrearVotacion">Crear votación</button>
          </div>
      </div>
  </div>
</div>

<script>
  // Agrega un nuevo campo de título al formulario de votación
  document.getElementById('btnAgregarTitulo').addEventListener('click', () => {
    const titulosContainer = document.getElementById('titulosAdicionales');
    
    // Calcula el número del siguiente título, partiendo de los dos primeros (1 y 2)
    const count = titulosContainer.children.length + 3;

    // Crea un nuevo div con un input para un nuevo título
    const div = document.createElement('div');
    div.className = 'form-group';
    div.innerHTML = `
      <label for="titulo${count}">Título ${count}</label>
      <input type="text" class="form-control" id="titulo${count}" placeholder="Ingrese el título ${count}">
    `;

    // Agrega el nuevo campo al contenedor de títulos adicionales
    titulosContainer.appendChild(div);
  });

  // Maneja el evento de creación de una nueva votación
  document.getElementById('btnCrearVotacion').addEventListener('click', async () => {
    const diasVotacion = document.getElementById('diasVotacion').value.trim();

    // Validación: Verifica que el número de días haya sido ingresado
    if (!diasVotacion) {
      return Swal.fire({
        icon: 'warning',
        title: 'Campo obligatorio',
        text: 'Por favor, ingrese el número de días de votación.',
      });
    }

    const titulos = [];

    // Obtiene los dos primeros títulos obligatorios
    const titulo1 = document.getElementById('titulo1').value.trim();
    const titulo2 = document.getElementById('titulo2').value.trim();

    // Validación: Verifica que los dos primeros títulos hayan sido ingresados
    if (!titulo1 || !titulo2) {
      return Swal.fire({
        icon: 'warning',
        title: 'Campos obligatorios',
        text: 'Debe ingresar al menos dos títulos.',
      });
    }

    // Agrega los dos títulos iniciales al arreglo
    titulos.push(titulo1, titulo2);

    // Recorre los títulos adicionales (si los hay) y los agrega si no están vacíos
    const titulosAdicionales = document.getElementById('titulosAdicionales').children;
    for (let i = 0; i < titulosAdicionales.length; i++) {
      const input = titulosAdicionales[i].querySelector('input');
      if (input && input.value.trim()) {
        titulos.push(input.value.trim());
      }
    }

    // Calcula las fechas de inicio y fin de la votación
    const fechaInicio = new Date();
    const fechaFin = new Date();
    fechaFin.setDate(fechaInicio.getDate() + parseInt(diasVotacion));

    // Prepara el objeto de datos para enviar al backend
    const votacionData = {
      Libro: titulos.map(titulo => ({ name: titulo, votos: 0 })), // Cada libro inicia con 0 votos
      F_Inicio: fechaInicio.toISOString().split('T')[0], // Fecha en formato YYYY-MM-DD
      F_Fin: fechaFin.toISOString().split('T')[0],
      clubId: club // Variable `club` debe estar definida globalmente
    };

    try {
      // Obtiene el token JWT del almacenamiento local
      const token = localStorage.getItem('jwtToken');

      // Envía los datos de votación al servidor
      const response = await fetch('https://read-it-es-e4ec0ccdc25d.herokuapp.com/votaciones', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` // Autenticación con JWT
        },
        body: JSON.stringify(votacionData)
      });

      // Si la solicitud fue exitosa
      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Votación creada',
          text: 'La votación se creó exitosamente.',
          confirmButtonText: 'OK'
        }).then(() => {
          hideModal('modalCrearVotacion'); // Cierra el modal
          location.reload(); // Recarga la página para reflejar los cambios
        });

      // Si hubo un error del servidor
      } else {
        const errorData = await response.json();
        Swal.fire({
          icon: 'error',
          title: 'Error al crear la votación',
          text: errorData.error || 'Error desconocido',
        });
      }

    // Si ocurre un error de red o inesperado
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Error de red',
        text: error.message,
      });
    }
  });
</script>

<script>
  document.getElementById('acerca-link').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'block';
  });
  
  document.getElementById('cerrar-modal').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'none';
  });
  
  // Opcional: cerrar modal al hacer clic fuera del contenido
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('modal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
  </script>

<!-- Modal para editar los datos de un club existente -->
<div class="modal" id="modalActualizarClub" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <!-- Encabezado del modal -->
      <div class="modal-header">
        <h5 class="modal-title">Editar club</h5>
        <!-- Botón para cerrar el modal -->
        <button type="button" class="close" onclick="hideModal('modalActualizarClub')" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Cuerpo del modal con el formulario -->
      <div class="modal-body">
        <form id="formActualizarClub">
          <!-- Mensaje informativo -->
          <small class="form-text text-muted" style="text-align: right">* Todos los campos son obligatorios *</small>

          <!-- Campo: nombre del club (deshabilitado, no editable) -->
          <div class="form-group">
            <label for="nombreClub">Nombre del club</label>
            <input type="text" class="form-control" id="nombreClub" placeholder="Ingrese el nombre del club" disabled>
          </div>

          <!-- Campo: género del club -->
          <div class="form-group">
            <label for="generoClub">Género del club</label>
            <input type="text" class="form-control" id="generoClub" placeholder="Ingrese el género literario del club" required>
          </div>

          <!-- Campo: descripción del club -->
          <div class="form-group">
            <label for="descripcionClub">Descripción</label>
            <textarea class="form-control" id="descripcionClub" rows="3" placeholder="Ingrese una descripción del club" required></textarea>
          </div>

          <!-- Campo: archivo de portada -->
          <div class="form-group">
            <label for="portadaClub">Portada</label>
            <input type="file" class="form-control-file" id="portadaClub">
          </div>
        </form>
      </div>

      <!-- Botones de acción -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('modalActualizarClub')">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="actualizarClub()">Editar club</button>
      </div>
    </div>
  </div>
</div>
<!-- Inclusión de librerías necesarias -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> <!-- jQuery slim (no incluye AJAX) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script> <!-- Popper.js (usado para tooltips y popovers de Bootstrap) -->

<script>
// Evento al hacer clic en el botón "Subir libro"
document.getElementById('btnSubirLibro').addEventListener('click', async () => {
  const form = document.getElementById('formSubirLibro');
  const subirLibroBtn = document.getElementById('btnSubirLibro');

  // Validar formulario con validación nativa del navegador
  if (!form.checkValidity()) {
    form.reportValidity(); 
    return;
  }

  // Desactivar el botón para evitar envíos múltiples
  subirLibroBtn.disabled = true;

  // Obtener valores de los campos del formulario
  const titulo = document.getElementById('tituloLibro').value;
  const autor = document.getElementById('autorLibro').value;
  const descripcion = document.getElementById('descripcionLibro').value;
  const fechaInicio = document.getElementById('fechaInicioLibro').value;
  const fechaFin = document.getElementById('fechaFinLibro').value;
  const portadaFile = document.getElementById('portadaLibro').files[0];
  const archivoFile = document.getElementById('archivoLibro').files[0];

  // Validación adicional
  if (!titulo || !autor || !descripcion || !fechaInicio || !fechaFin) {
    Swal.fire({
      title: '¡Campos incompletos!',
      text: 'Por favor, complete todos los campos obligatorios.',
      icon: 'warning',
      confirmButtonText: 'Cerrar'
    });
    subirLibroBtn.disabled = false;
    return;
  }

  // Crear un objeto FormData para enviar datos como multipart/form-data
  const formData = new FormData();
  formData.append('Libro', titulo);
  formData.append('Autor', autor);
  formData.append('descripcion', descripcion);
  formData.append('F_Inicio', fechaInicio);
  formData.append('F_Fin', fechaFin);
  if (portadaFile) formData.append('portadaLibro', portadaFile);
  if (archivoFile) formData.append('archivoLibro', archivoFile);
  formData.append('clubId', club); // ID del club (variable global)

  try {
    // Obtener token JWT del almacenamiento local
    const token = localStorage.getItem('jwtToken');

    // Enviar solicitud POST al servidor
    const response = await fetch('https://read-it-es-e4ec0ccdc25d.herokuapp.com/libros', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });

    // Verificar respuesta
    if (response.ok) {
      Swal.fire({
        title: '¡Éxito!',
        text: 'Libro subido exitosamente.',
        icon: 'success',
        timer: 5000,
        willClose: () => location.reload()
      });
    } else {
      const errorData = await response.json();
      Swal.fire({
        title: '¡Error!',
        text: 'Error al subir el libro: ' + (errorData.error || 'Error desconocido'),
        icon: 'error',
        confirmButtonText: 'Intentar de nuevo'
      });
      subirLibroBtn.disabled = false;
    }
  } catch (error) {
    Swal.fire({
      title: '¡Error!',
      text: 'Error al subir el libro: ' + error.message,
      icon: 'error',
      confirmButtonText: 'Intentar de nuevo'
    });
    subirLibroBtn.disabled = false;
  }
});
</script>

<script>
// Evento al hacer clic en el botón "Crear evento"
document.getElementById('btnCrearEvento').addEventListener('click', () => {
  const form = document.getElementById('formCrearEvento');
  
  // Validar formulario
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  // Obtener datos del formulario
  const nombreEvento = document.getElementById('nombreEvento').value.trim();
  const descripcionEvento = document.getElementById('descripcionEvento').value.trim();
  const fechaEvento = document.getElementById('fechaEvento').value;
  const horaEvento = document.getElementById('horaEvento').value;
  const horaFin = document.getElementById('horaFin').value;
  const tipoEvento = document.querySelector('input[name="tipoEvento"]:checked').value;
  const lugarEvento = document.getElementById('lugarEvento').value.trim();
  const portadaEventoFile = document.getElementById('portadaEvento').files[0];

  // Validación manual
  if (!nombreEvento || !descripcionEvento || !fechaEvento || !horaEvento || !lugarEvento || !horaFin) {
    Swal.fire({
      title: '¡Error!',
      text: 'Por favor, complete todos los campos obligatorios.',
      icon: 'error',
      confirmButtonText: 'Cerrar'
    });
    return;
  }

  // Si se sube una portada, convertirla a base64 para enviarla en JSON
  if (portadaEventoFile) {
    const reader = new FileReader();
    reader.onload = async function(event) {
      const portadaBase64 = event.target.result;

      // Crear objeto con los datos del evento
      const eventoData = {
        Evento: nombreEvento,
        Descripcion: descripcionEvento,
        Fecha: fechaEvento,
        Hora: horaEvento,
        HoraF: horaFin,
        Tipo: tipoEvento === 'virtual' ? 'Virtual' : 'Presencial',
        info: lugarEvento,
        Portada: portadaBase64,
        clubId: club
      };

      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch('https://read-it-es-e4ec0ccdc25d.herokuapp.com/eventos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventoData)
        });

        if (response.ok) {
          Swal.fire({
            title: '¡Éxito!',
            text: 'Evento creado exitosamente',
            icon: 'success',
            timer: 5000,
            willClose: () => {
              hideModal('modalCrearEvento');
              location.reload();
            }
          });
        } else {
          const errorData = await response.json();
          Swal.fire({
            title: '¡Error!',
            text: 'Error al crear el evento: ' + (errorData.error || 'Error desconocido'),
            icon: 'error',
            confirmButtonText: 'Intentar de nuevo'
          });
        }
      } catch (error) {
        Swal.fire({
          title: '¡Error!',
          text: 'Error al crear el evento: ' + error.message,
          icon: 'error',
          confirmButtonText: 'Intentar de nuevo'
        });
      }
    };
    reader.readAsDataURL(portadaEventoFile); // Leer archivo como base64
  } else {
    // Si no hay imagen, enviar datos sin la portada
    const eventoData = {
      Evento: nombreEvento,
      Descripcion: descripcionEvento,
      Fecha: fechaEvento,
      Hora: horaEvento,
      Tipo: tipoEvento === 'virtual' ? 'Virtual' : 'Presencial',
      info: lugarEvento,
      clubId: club
    };

    (async () => {
      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch('https://read-it-es-e4ec0ccdc25d.herokuapp.com/eventos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventoData)
        });

        if (response.ok) {
          Swal.fire({
            title: '¡Éxito!',
            text: 'Evento creado exitosamente',
            icon: 'success',
            timer: 5000,
            willClose: () => {
              hideModal('modalCrearEvento');
              location.reload();
            }
          });
        } else {
          const errorData = await response.json();
          Swal.fire({
            title: '¡Error!',
            text: 'Error al crear el evento: ' + (errorData.error || 'Error desconocido'),
            icon: 'error',
            confirmButtonText: 'Intentar de nuevo'
          });
        }
      } catch (error) {
        Swal.fire({
          title: '¡Error!',
          text: 'Error al crear el evento: ' + error.message,
          icon: 'error',
          confirmButtonText: 'Intentar de nuevo'
        });
      }
    })();
  }
});
</script>
</body>
</html>

<script>
  function toggleLugar() {
      let isVirtual = document.getElementById("virtual").checked;
      let labelLugar = document.getElementById("labelLugar");
      let inputLugar = document.getElementById("lugarEvento");

      if (isVirtual) {
          labelLugar.innerText = "Link a videollamada";
          inputLugar.placeholder = "Ingrese el enlace a la videollamada";
      } else {
          labelLugar.innerText = "Dirección del evento";
          inputLugar.placeholder = "Ingrese la dirección del evento";
      }
  }
</script>
<script>
  function toggleMembership(button) {
      let memberCountElement = document.getElementById("memberCount");
      let currentMembers = parseInt(memberCountElement.textContent);

      if (button.textContent === "Unirse al Club") {
          button.textContent = "Miembro del Club";
          button.classList.remove("btn-primary");
          button.classList.add("btn-success");
          memberCountElement.textContent = currentMembers + 1;
      } else {
          button.textContent = "Unirse al Club";
          button.classList.remove("btn-success");
          button.classList.add("btn-primary");
          memberCountElement.textContent = currentMembers - 1;
      }
  }
</script>
    
<script>
    let club = "";
    let clubActual = {}; // Guarda la información actual del club

    function fetchAndDisplayClub() {
        const params = new URLSearchParams(window.location.search);
        club = params.get("_id") || sessionStorage.getItem('selectedClub');

        if (club) {

            fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/clubes/${encodeURIComponent(club)}`)
                .then(response => response.json())
                .then(club => {
                    clubActual = club;

                    // Update page elements
                    document.getElementById("NombreClub").textContent = club.NombreClub;
                    document.querySelector(".club-banner").src = club.Portada;
                    document.querySelector(".text-muted").textContent = club.Descripcion;
                    document.getElementById("admin").textContent = "Administrado por: " + club.Administrador.name;
                    document.getElementById("admin").style = "cursor: pointer;";
                    document.getElementById("admin").onclick = function () { verPerfil(club.Administrador._id); }
                    document.getElementById("memberCount").textContent = club.Miembros;
                    document.getElementById("genero").textContent = club.Genero;

                    // Update form fields in edit modal
                    document.getElementById("nombreClub").value = club.NombreClub || "";
                    document.getElementById("descripcionClub").value = club.Descripcion || "";
                    document.getElementById("generoClub").value = club.Genero || "";

                    cargarLecturas(club.Lecturas_curso);
                    cargarEventos(club.Eventos);
                })
                .catch(error => console.error("Error al obtener los detalles del club:", error));
        }
    }

    function verPerfil(id) {
      localStorage.setItem("userId", id);
      window.location.href = "verperfil.html";
    }

    document.addEventListener("DOMContentLoaded", fetchAndDisplayClub);

    function mostrarModalEditar() {
        document.getElementById("modalActualizarClub").style.display = "block";
    }

    function cerrarModalEditar() {
        document.getElementById("modalActualizarClub").style.display = "none";
    }

    function actualizarClub() {
      const form = document.getElementById('formActualizarClub');
      if (!form.checkValidity()) {
          form.reportValidity(); // Muestra los mensajes nativos de validación
          return;
      }  
      const descripcion = document.getElementById("descripcionClub").value;
        const genero = document.getElementById("generoClub").value;
        const portadaInput = document.getElementById("portadaClub");

        if (portadaInput.files.length > 0) {
            const reader = new FileReader();
            reader.readAsDataURL(portadaInput.files[0]);
            reader.onload = function () {
                const portadaBase64 = reader.result; // Convertimos la imagen a Base64

                enviarActualizacion(descripcion, genero, portadaBase64);
            };
        } else {
            // Si no se seleccionó nueva imagen, usamos la portada actual
            enviarActualizacion(descripcion, genero, clubActual.Portada);
        }
    }

    function enviarActualizacion(descripcion, genero, portada) {
        const clubActualizado = {
            "Descripcion": descripcion,
            "Genero": genero,
            "Portada": portada // Imagen en Base64 o la URL actual
        };

        fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/clubes/${encodeURIComponent(club)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clubActualizado)
        })
        .then(response => response.json())
        .then(data => {
            // Simulación de éxito de la solicitud
            Swal.fire({
                  title: 'Éxito!',
                  text: 'Club actualizado exitosamente.',
                  icon: 'success',
                  timer: 4000, // Se cerrará automáticamente después de 10 segundos
                  willClose: () => {  // Usamos 'willClose' para ejecutar código antes de que se cierre
                      hideModal('modalActualizarClub');
                      // Aquí puedes recargar la página o hacer otras acciones
                      location.reload();
                  }
              });
              cerrarModalEditar(); // Asegúrate de que esta función no recargue la página
            })
        .catch(error => {
            console.error("Error al actualizar el club:", error);
          // En caso de error
          Swal.fire({
            title: 'Error!',
            text: 'Hubo un problema al actualizar el club.',
            icon: 'error',
            timer: 3000, // Se cerrará automáticamente después de 2 segundos
            confirmButtonText: 'Intentar de nuevo'
          });        
        });
    }

    function cargarLecturas(lecturas) {
        let lecturasContainer = document.getElementById("libros");
        lecturasContainer.innerHTML = "";

        // Fetch all book details first
        Promise.all(lecturas.map(libro =>
            fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/libros/${libro}`).then(response => response.json())
        )).then(librosData => {
            const now = new Date();

            // Separate books into in-progress and finished
            const inProgressBooks = librosData.filter(book => new Date(book.F_Fin) >= now);
            const finishedBooks = librosData.filter(book => new Date(book.F_Fin) < now);

            // Helper function to render books
            function renderBooks(books) {
                return books.map(data => `
                <div class="container mt-4" style="margin-bottom: 20px; background-color: #fbfbe9; border-radius: 3%; padding: 10px 10px;">
                    <div class="row align-items-center book-card">
                        <div class="col-md-4" style="text-align: center;">
                            <img class="img-fluid book-cover" src="${data.Portada}" alt="${data.Libro}">
                        </div>
                        <div class="col-md-8">
                            <h5>${data.Libro}</h5>
                            <p><strong>Autor:</strong> ${data.Autor}</p>
                            <p class="book-description" style="text-align: justify;">${data.descripcion}</p>
                            <p><strong>Inicio:</strong> ${data.F_Inicio}</p>
                            <p><strong>Fin:</strong> ${data.F_Fin}</p>
                            <button class="btn btn-primary btn-sm" onclick="goToDiscussion('${data._id}')">
                                <i class="fas fa-comments"></i> Ir a la discusión
                            </button>
                        </div>
                    </div>
                </div>`).join('');
            }

            // Render in-progress books section
            let html = '';
            if (inProgressBooks.length > 0) {
                html += '<h4>Libros en curso</h4>';
                html += renderBooks(inProgressBooks);
            }

            // Render finished books section
            if (finishedBooks.length > 0) {
                html += '<h4>Libros finalizados</h4>';
                html += renderBooks(finishedBooks);
            }

            lecturasContainer.innerHTML = html;
        });
    }

        function cargarEventos(eventos) {
        let eventosContainer = document.getElementById("eventos");
        eventosContainer.innerHTML = "";

        const now = new Date();
        let upcomingEventsCount = 0;

        eventos.forEach(evento => {
          fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/eventos/${evento}`)
            .then(response => response.json())
            .then(evento => {
              const eventoFecha = new Date(evento.Fecha);
              if (eventoFecha >= now) {
                upcomingEventsCount++;
                let eventoCard = `
                    <div class="container mt-4" style="margin-bottom: 20px; background-color: #fbfbe9; border-radius: 3%; padding: 10px 10px;">
                        <div class="row align-items-center event-card">
                            <div class="col-md-4">
                                <img class="img-fluid" src="${ evento.Portada }" alt="Portada del evento">
                            </div>
                            <div class="col-md-8">
                                <h5>${evento.Evento}</h5>
                                <p>${evento.Descripcion}</p>
                                <p><i class="far fa-calendar-alt"></i> ${evento.Fecha}, ${evento.Hora} - ${evento.HoraF}</p>
                                <p><i class="fas fa-${evento.Tipo === 'Virtual' ? 'video' : 'map-marker-alt'}"></i> ${evento.Tipo}</p>
                                ${evento.Tipo === 'Virtual' ? '<p>Link de la llamada: <a href="'+evento.info+'">'+evento.info+'<a></p>' :
                                '<p>Direccion: '+evento.info+'</p>' }
                            </div>
                        </div>
                    </div>`;
                eventosContainer.innerHTML += eventoCard;
              }
              if (upcomingEventsCount === 0) {
                eventosContainer.innerHTML = "<p>No hay eventos próximos disponibles.</p>";
              }
            });
        });
    }
</script>

<!-- VOTACIONES DE Lecturas -->
<script>
    const barContainer = document.getElementById('barContainer');
    const voteButtons = document.getElementById('voteButtons');
    const mensajeVoto = document.getElementById('mensajeVoto');
  
    let currentVotacion = null;
    let userHasVoted = false;
  
    // Check if user has voted stored in localStorage by votacion ID
    function checkUserVoted(votacionId) {
      const voted = localStorage.getItem(`votoRealizado_${votacionId}`);
      return voted === 'true';
    }
  
    // Save user vote in localStorage
    function setUserVoted(votacionId) {
      localStorage.setItem(`votoRealizado_${votacionId}`, 'true');
    }
  
    // Render the votacion chart bars
    function renderChart() {
      barContainer.innerHTML = '';
      const totalVotos = currentVotacion.Libro.reduce((sum, libro) => sum + libro.votos, 0) || 1;

      currentVotacion.Libro.forEach(libro => {
        const porcentaje = (libro.votos / totalVotos) * 100;

        const barWrapper = document.createElement('div');
        barWrapper.className = 'bar-wrapper';

        // Crear la barra
        const bar = document.createElement('div');
        bar.className = 'bar';

        const barFill = document.createElement('div');
        barFill.className = 'bar-fill';
        barFill.style.width = porcentaje + '%';

        bar.appendChild(barFill);

        // Crear el contenedor para el nombre y los votos, alineado a la derecha
        const nameContainer = document.createElement('div');
        nameContainer.className = 'bar-name-container';
        nameContainer.textContent = `${libro.name} — ${libro.votos} voto(s)`;

        // Añadir la barra y el contenedor del nombre al contenedor general
        barWrapper.appendChild(bar);
        barWrapper.appendChild(nameContainer);
        barContainer.appendChild(barWrapper);
      });
    }

    function renderButtons() {
      voteButtons.innerHTML = '';
  
      if (userHasVoted) {
        mensajeVoto.textContent = 'Ya has votado. Gracias por participar.';
        return;
      }
  
      currentVotacion.Libro.forEach(libro => {
        const btn = document.createElement('button');
        btn.classList.add("votaciones");
        btn.textContent = `Votar por "${libro.name}"`;
        btn.onclick = async () => {
          try {
            const token = localStorage.getItem('jwtToken');
            const payloadBase64 = token.split('.')[1];
            const payloadJson = atob(payloadBase64);
            const user = JSON.parse(payloadJson);
            const userId = user.id;

            const response = await fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/votaciones/${currentVotacion._id}/vote`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ tituloVotado: libro.name, id: userId })
            });
  
            if (response.ok) {
              const updatedVotacion = await response.json();
              currentVotacion = updatedVotacion;
              userHasVoted = true;
              setUserVoted(currentVotacion._id);
              mensajeVoto.textContent = `Gracias por votar por "${libro.name}"`;
              renderChart();
              renderButtons();
            } else {
              const errorData = await response.json();
              alert('Error al guardar el voto: ' + (errorData.error || 'Error desconocido'));
            }
          } catch (error) {
            alert('Error al guardar el voto: ' + error.message);
          }
        };
        voteButtons.appendChild(btn);
      });
    }
  
    // Fetch current votacion for the club and initialize UI
    async function fetchCurrentVotacion() {
      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/votaciones/club/${club}/current`);
  
        if (response.ok) {
          if (response.status === 201) {
          mensajeVoto.textContent = 'No hay votación activa en este momento.';
          barContainer.innerHTML = '';
          voteButtons.innerHTML = '';
        } else {
          currentVotacion = await response.json();

          // Check if user has voted by calling the new API endpoint
          const userId = tokenData ? tokenData.id : null;
          if (userId && currentVotacion && currentVotacion._id) {
            const voteCheckResponse = await fetch(`https://read-it-es-e4ec0ccdc25d.herokuapp.com/votaciones/${currentVotacion._id}/user/${userId}`);
            if (voteCheckResponse.ok) {
              const voteCheckData = await voteCheckResponse.json();
              userHasVoted = voteCheckData.hasVoted;
            } else {
              userHasVoted = false;
            }
          } else {
            userHasVoted = false;
          }

          renderChart();
          renderButtons();
        }
        } else {
          const errorData = await response.json();
          alert('Error al obtener la votación: ' + (errorData.error || 'Error desconocido'));
        }
      } catch (error) {
        alert('Error al obtener la votación: ' + error.message);
      }
    }
  
    document.addEventListener('DOMContentLoaded', () => {
      fetchCurrentVotacion();
    });
  </script>