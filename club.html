<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ReadIt Club</title>
    <link rel="icon" href="images/logo.png">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="styles.css" rel="stylesheet"> <!-- Archivo CSS externo -->

    <script>
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp;
                if (!exp) return true;
                const now = Math.floor(Date.now() / 1000);
                return now >= exp;
            } catch (e) {
                return true;
            }
        }

        function decodeToken(token) {
            if (!token) return null;
            try {
                const payloadBase64 = token.split('.')[1];
                const payloadJson = atob(payloadBase64);
                return JSON.parse(payloadJson);
            } catch (e) {
                console.error('Error decoding token:', e);
                return null;
            }
        }

        let tokenData;
        let rol;
        document.addEventListener('DOMContentLoaded', () => {
          const token = localStorage.getItem('jwtToken');
          if (!token || isTokenExpired(token)) {
              Swal.fire({
                  icon: 'warning',
                  title: 'Sesi√≥n expirada',
                  text: 'Por favor, inicia sesi√≥n de nuevo.',
                  confirmButtonText: 'Ir a iniciar sesi√≥n'
              }).then(() => {
                  window.location.href = 'signing.html';
              });
              return; // Evita continuar si el token no es v√°lido
          }
          let img = document.getElementById('imgperfil');
          if(tokenData && tokenData.picture) {
              img.src = tokenData.picture;
          }
          tokenData = decodeToken(token);
      });
    </script>
    <script>
        function showSection(sectionId, tabId) {
            document.getElementById('informacion').style.display = 'none';
            document.getElementById('lecturas').style.display = 'none';
            document.getElementById('seccionEventos').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';

            document.getElementById('tab-informacion').classList.remove('active-tab');
            document.getElementById('tab-lecturas').classList.remove('active-tab');
            document.getElementById('tab-eventos').classList.remove('active-tab');
            document.getElementById(tabId).classList.add('active-tab');
        }
        function showSection2(sectionId, tabId) {
            document.getElementById('libro-curso').style.display = 'none';
            document.getElementById('proxima-lectura').style.display = 'none';
            document.getElementById(sectionId).style.display = 'block';

            document.getElementById('tab-libro-curso').classList.remove('active-tab');
            document.getElementById('tab-proxima-lectura').classList.remove('active-tab');
            document.getElementById(tabId).classList.add('active-tab');
        }

        function toggleEvento() {
            let tipoEvento = document.getElementById("tipoEvento").value;
            let campoVirtual = document.getElementById("campoVirtual");
            let campoPresencial = document.getElementById("campoPresencial");

            if (tipoEvento === "virtual") {
                campoVirtual.classList.remove("d-none");
                campoPresencial.classList.add("d-none");
            } else {
                campoVirtual.classList.add("d-none");
                campoPresencial.classList.remove("d-none");
            }
        }

        function toggleProfileMenu() {
            let menu = document.getElementById('profile-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleNotificationMenu() {
            let menu = document.getElementById('notification-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleFavorite(icon) {
            icon.classList.toggle('fas');
            icon.classList.toggle('far');
        }

        function toggleOptionsMenu(menuId) {
            const menu = document.getElementById(menuId);
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function goToClubPage() {
            window.location.href = 'club.html';
        }

        function goToDiscussion(libroId) {
            localStorage.setItem('selectedLibroId', libroId);
            window.location.href = 'discusion.html';
        }
    </script>
</head>
<body class="bg-light">
<header class="bg-warning p-4 d-flex justify-content-between align-items-center">
  <a href="main.html">
    <div class="d-flex align-items-center">
        <img alt="Logo" class="rounded-circle" height="60" src="images/logo.png" width="60"/>
        <h1 class="text-dark font-weight-bold ml-2">Read-It</h1>
    </div>
</a>  
    <div class="d-flex align-items-center">
        <input class="form-control rounded-left" placeholder="Buscar" type="text"/>
        <button class="btn btn-dark rounded-right" >
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="notification-container d-flex align-items-center position-relative" onclick="toggleNotificationMenu()">
            <i class="fas fa-bell text-dark mr-3 position-relative" style="font-size: 1.5rem;">
                <span id="notification-badge" class="badge badge-danger position-absolute" style="top: -15px; right: -15px; display: none;">3</span>
            </i>
            <div id="notification-menu" class="notification-menu">
                <a href="#" class="notification-item unread" onclick="markAsRead(event, this)">Notificaci√≥n 1</a>
                <a href="#" class="notification-item unread" onclick="markAsRead(event, this)">Notificaci√≥n 2</a>
                <a href="#" class="notification-item unread" onclick="markAsRead(event, this)">Notificaci√≥n 3</a>
            </div>
        </div> 
    
        <div class="profile-container d-flex align-items-center" onclick="toggleProfileMenu()">
            <img id="imgperfil" src="images/fotoperfil.jpg" alt="Perfil" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;">
            <i id="profile-arrow" class="fas fa-chevron-down text-dark ml-2 "></i>
            <div id="profile-menu" class="profile-menu">
                <a href="myprofile.html">Mi perfil</a>
                <a href="#" onclick="logout()">Cerrar sesi√≥n</a>
            </div>
        </div>
    </div>
</header>
<div class="d-flex align-items-center bg-primary" style="height: 5px;"></div>
<img alt="Club Rom√°ntica" class="card-img-top club-banner" src="https://storage.googleapis.com/a1aa/image/zrtnSTdJfTjgSJ6YfnlvKs-GNyU8JoToDo1kETZvyK4.jpg"/>
<div class="d-flex align-items-center bg-primary" style="height: 70px;">
  <h1 class="text-white font-weight-bold ml-2" id="NombreClub"></h1>
</div>

<div class="container-fluid">
  <div class="row align-items-center">
    <!-- G√©nero literario alineado a la izquierda -->
    <div class="col-6">
      <h3 class="text-dark font-weight-bold ml-2" style="margin-top: 10px;">G√©nero literario del club: </h3><h4 class="text-dark font-weight-bold ml-2" id="genero"></h4>
    </div>

    <!-- Bot√≥n y Me gusta alineados a la derecha con margen superior -->
    <div class="col-6 d-flex justify-content-end align-items-center flex-wrap mt-3">
        <button class="btn btn-primary join-btn" onclick="toggleMembership(this)" id="Miembro" style="display: none;">Unirse al Club</button>
        <button class="btn btn-primary join-btn" onclick="mostrarModalEditar()" id="btn-admin" style="display: none;">Editar Club</button>
      <script>
        const token = localStorage.getItem('jwtToken');
        tokenData = decodeToken(token);
        const params = new URLSearchParams(window.location.search);
        club = params.get("_id") || sessionStorage.getItem('selectedClub');
        fetch(`http://localhost:3050/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/rol`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const rol = data.role;
                if (rol === 'none') {
                    const miembroElem = document.getElementById("Miembro");
                    const votacion = document.getElementById("voteButtons");
                    votacion.style.display = "none";
                    miembroElem.style.display = "block";
                    miembroElem.classList.remove("btn-primary");
                    miembroElem.classList.add("btn-success");
                    miembroElem.textContent = "Unirse al Club";
                    miembroElem.onclick = () => {
                        fetch(`http://localhost:3050/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/add-miembro`, {
                            method: 'POST',
                        })
                        .then(response => {
                              if (response.ok) {
                                fetch(`http://localhost:3050/usuarios/${tokenData.id}/insignia/680e4e964d4e9715973c6ac8/add`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                });
                                Swal.fire({
                                  icon: 'success',
                                  title: '¬°√âxito!',
                                  text: 'Te has unido al club.',
                                  timer: 3000,
                                  confirmButtonText: 'Aceptar'
                                }).then(() => {
                                  location.reload();
                                });
                            } else {
                              Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                timer: 3000,
                                text: 'Error al unirse al club.',
                              });
                            }
                        })
                        .catch(() => {
                            Swal.fire({
                              icon: 'error',
                              title: 'Error',
                              timer: 3000,
                              text: 'Error al unirse al club. Verifica tu conexi√≥n.',
                            });
                          });
                    };
                } else if (rol === 'member') {
                    const miembroElem = document.getElementById("Miembro");
                    miembroElem.style.display = "block";
                    miembroElem.classList.add("btn-primary");
                    miembroElem.classList.remove("btn-success");
                    miembroElem.textContent = "Salir del club";
                    miembroElem.onclick = () => {
                        fetch(`http://localhost:3050/usuarios/${encodeURIComponent(tokenData.id)}/club/${encodeURIComponent(club)}/remove-miembro`, {
                            method: 'DELETE',
                        })
                        .then(response => {
                          if (response.ok) {
                              Swal.fire({
                                icon: 'success',
                                title: 'Has salido del club',
                                text: 'Esperamos verte de nuevo pronto.',
                                timer: 4000,
                                confirmButtonText: 'Aceptar'
                              }).then(() => {
                                location.reload();
                              });
                          } else {
                            Swal.fire({
                              icon: 'error',
                              title: 'Error',
                              timer: 5000,
                              text: 'No se pudo salir del club.',
                            });
                          }
                        })
                        .catch(() => {
                          Swal.fire({
                            icon: 'error',
                            title: 'Error de red',
                            timer: 5000,
                            text: 'Ocurri√≥ un problema al intentar salir del club.',
                          });
                        });
                      };
                } else if (rol === 'admin') {
                    const adminElem = document.getElementById("btn-admin");
                    const libro = document.getElementById("subirLibro");
                    const evento = document.getElementById("crearEvento");
                    const votacion = document.getElementById("crearVotacion");
                    adminElem.style.display = "block";
                    libro.style.display = "block";
                    evento.style.display = "block";
                    votacion.style.display = "block";
                    adminElem.onclick = () => {
                        mostrarModalEditar();
                    };
                }
            });

            function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'signing.html'; // Redirige al login
        }
      </script>

      <!-- Me gusta -->
      <span class="like-btn ml-3 text-danger"><i class="far fa-heart"></i> 120</span>
    </div>
  </div>
</div>

<nav class="bg-white shadow-sm">
    <ul class="nav justify-content-right p-3">
        <li class="nav-item">
            <a id="tab-informacion" class="nav-link text-warning active-tab" href="javascript:void(0);" onclick="showSection('informacion', 'tab-informacion')">Informaci√≥n</a>
        </li>
        <li class="nav-item">
            <a id="tab-lecturas" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection('lecturas', 'tab-lecturas')">Lecturas</a>
        </li>
        <li class="nav-item">
          <a id="tab-eventos" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection('seccionEventos', 'tab-eventos')">Eventos</a>
      </li>
    </ul>
</nav>
<main class="p-4">
    <section id="informacion">
        <h2 class="font-weight-bold mb-3">Descripci√≥n</h2>
        <p class="text-muted"></p>
    
        <section class="mt-5">
            <h2 class="font-weight-bold mb-3">Sobre el club</h2>
                <!-- Administrador y Miembros -->
                <p class="mt-2" id="admin">Administrado por: <strong></strong></p>
                <p>Miembros: <strong id="memberCount"></strong></p>
        </section>
    </section>
    
    <section id="lecturas" style="display: none;">
        <nav class="bg-white shadow-sm">
            <ul class="nav justify-content-right p-3">
                <li class="nav-item">
                    <a id="tab-libro-curso" class="nav-link text-warning active-tab" href="javascript:void(0);" onclick="showSection2('libro-curso', 'tab-libro-curso')">Libros en curso</a>
                </li>
                <li class="nav-item">
                    <a id="tab-proxima-lectura" class="nav-link text-dark" href="javascript:void(0);" onclick="showSection2('proxima-lectura', 'tab-proxima-lectura')">Votaci√≥n pr√≥xima lectura</a>
                </li>
            </ul>
        </nav>

    <section id="libro-curso" >
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="font-weight-bold">Lecturas del club</h3>
            <button class="btn btn-success" onclick="showModal('modalSubirLibro')" id="subirLibro" style="display: none;">
                <i class="fas fa-plus"></i> Subir libro
            </button>
        </div>
  
      <div class="container mt-4" id="libros"></div>    
  </section>  

  <section id="proxima-lectura" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="font-weight-bold">Votaciones del club en curso</h3>
      <button class="btn btn-success" onclick="showModal('modalCrearVotacion')" id="crearVotacion" style="display: none;">
        <i class="fas fa-plus"></i> Crear votaci√≥n
      </button>
    </div>

    <div class="card text-center">
      <h5>Gr√°fico de votaci√≥n entre t√≠tulos</h5>
      <div id="chart" class="bg-light border rounded p-3">
        <div class="bar-container" id="barContainer">
          <!-- Barras generadas din√°micamente -->
        </div>
      </div>
    
      <div class="vote-buttons" id="voteButtons">
        <!-- Botones generados din√°micamente -->
      </div>
    </div>
  
    <div class="mensaje" id="mensajeVoto"></div>
  </section>
</section>

</section>

<!-- Modal Crear Votacion -->
<div class="modal" id="modalCrearVotacion" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Crear votaci√≥n</h5>
              <button type="button" class="close" onclick="hideModal('modalCrearVotacion')" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
              <form id="formCrearVotacion">
                  <div class="form-group">
                      <label for="diasVotacion">Dias de votacion</label>
                      <input type="text" class="form-control" id="diasVotacion" placeholder="Ingrese el n√∫mero de dias de votaci√≥n" required>
                  </div>
                  <div class="form-group">
                      <label for="titulo1">T√≠tulo 1</label>
                      <input type="text" class="form-control" id="titulo1" placeholder="Ingrese el primer t√≠tulo" required>
                  </div>
                  <div class="form-group">
                      <label for="titulo2">T√≠tulo 2</label>
                      <input type="text" class="form-control" id="titulo2" placeholder="Ingrese el segundo t√≠tulo" required>
                  </div>
                  <div id="titulosAdicionales"></div>
                  <button type="button" class="btn btn-link" id="btnAgregarTitulo">Agregar otro t√≠tulo</button>
              </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="hideModal('modalCrearVotacion')">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btnCrearVotacion">Crear votaci√≥n</button>
          </div>
      </div>
  </div>
</div>

  <script>
  document.getElementById('btnAgregarTitulo').addEventListener('click', () => {
    const titulosContainer = document.getElementById('titulosAdicionales');
    const count = titulosContainer.children.length + 3;
    const div = document.createElement('div');
    div.className = 'form-group';
    div.innerHTML = `
      <label for="titulo${count}">T√≠tulo ${count}</label>
      <input type="text" class="form-control" id="titulo${count}" placeholder="Ingrese el t√≠tulo ${count}">
    `;
    titulosContainer.appendChild(div);
  });

  document.getElementById('btnCrearVotacion').addEventListener('click', async () => {
    const diasVotacion = document.getElementById('diasVotacion').value.trim();
    if (!diasVotacion) {
    return Swal.fire({
      icon: 'warning',
      title: 'Campo obligatorio',
      text: 'Por favor, ingrese el n√∫mero de d√≠as de votaci√≥n.',
    });
  }

    const titulos = [];
    const titulo1 = document.getElementById('titulo1').value.trim();
    const titulo2 = document.getElementById('titulo2').value.trim();

    if (!titulo1 || !titulo2) {
      return Swal.fire({
      icon: 'warning',
      title: 'Campos obligatorios',
      text: 'Debe ingresar al menos dos t√≠tulos.',
      });
    }

    titulos.push(titulo1, titulo2);

    const titulosAdicionales = document.getElementById('titulosAdicionales').children;
    for (let i = 0; i < titulosAdicionales.length; i++) {
      const input = titulosAdicionales[i].querySelector('input');
      if (input && input.value.trim()) {
        titulos.push(input.value.trim());
      }
    }

    // Calculate start and end dates based on current date and diasVotacion
    const fechaInicio = new Date();
    const fechaFin = new Date();
    fechaFin.setDate(fechaInicio.getDate() + parseInt(diasVotacion));
    console.log(club);
    const votacionData = {
      Libro: titulos.map(titulo => ({ name: titulo, votos: 0 })),
      F_Inicio: fechaInicio.toISOString().split('T')[0],
      F_Fin: fechaFin.toISOString().split('T')[0],
      clubId: club 
    };

    try {
      const token = localStorage.getItem('jwtToken');
      const response = await fetch('http://localhost:3050/votaciones', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(votacionData)
      });

      if (response.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Votaci√≥n creada',
        text: 'La votaci√≥n se cre√≥ exitosamente.',
        confirmButtonText: 'OK'
      }).then(() => {
        hideModal('modalCrearVotacion');
        location.reload();
      });
    } else {
      const errorData = await response.json();
      Swal.fire({
        icon: 'error',
        title: 'Error al crear la votaci√≥n',
        text: errorData.error || 'Error desconocido',
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error de red',
      text: error.message,
    });
  }
});
</script>



  <section id="seccionEventos" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="font-weight-bold">Pr√≥ximos Eventos</h3>
        <button class="btn btn-success" onclick="showModal('modalCrearEvento')" id="crearEvento" style="display: none;">
            <i class="fas fa-plus"></i> Crear Evento
        </button>
    </div>
    <div id="eventos">

    </div>
             
    </section>
    
</main>


<footer class="bg-dark text-white text-center py-3">
  <div class="container">
  <p class="mb-1">
      üìö connectReadit@gmail.com | 
      <a id="acerca-link" style="color: #4FC3F7; text-decoration: none;">Acerca de</a> | 
      ¬© 2025 Read-it
      </p>
  </div>
</footer>

<!-- Modal -->
<div id="modal">
  <div id="modal-content">
  <h2>Sobre el Equipo</h2>
  <img src="images/logo.png" style="height: 90px;">
  <p>Somos Read-it, un equipo apasionado por compartir el amor por la lectura. üìö‚ú®</p>
  <div class="row my-5">
      <div class="col-md-6 mb-4">
          <div class="card border-0 shadow-sm h-100">
              <div class="card-body text-center">
                  <img src="images/equipo/andrea.png" class="rounded-circle mb-3" width="100" height="100" alt="Andrea Escobar">
                  <h3 class="font-weight-bold">Andrea Escobar</h3>
                  <p class="font-weight-bold mb-0">ProductOwner</p>
                  <p class="text-muted">Desarrollo Frontend</p>
              </div>
          </div>
      </div>
      <div class="col-md-6 mb-4">
          <div class="card border-0 shadow-sm h-100">
              <div class="card-body text-center">
                  <img src="images/equipo/erik.png" class="rounded-circle mb-3" width="100" height="100" alt="Erik Moreno">
                  <h3 class="font-weight-bold">Erik Moreno</h3>
                  <p class="font-weight-bold mb-0">ScrumMaster</p>
                  <p class="text-muted">Desarrollo Backend.</p>
              </div>
          </div>
      </div>
  </div>
  <button id="cerrar-modal">Cerrar</button>
</div>
</div>

<script>
  document.getElementById('acerca-link').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'block';
  });
  
  document.getElementById('cerrar-modal').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'none';
  });
  
  // Opcional: cerrar modal al hacer clic fuera del contenido
  window.addEventListener('click', function(event) {
    const modal = document.getElementById('modal');
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
  </script>

<!-- Modal Actualizar Club -->
<div class="modal" id="modalActualizarClub" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar club</h5>
                <button type="button" class="close" onclick="hideModal('modalActualizarClub')" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formActualizarClub">
                  <div class="form-group">
                      <label for="nombreClub">Nombre del club</label>
                      <input type="text" class="form-control" id="nombreClub" placeholder="Ingrese el nombre del club" disabled>
                  </div>
                  <div class="form-group">
                      <label for="generoClub">G√©nero del club</label>
                      <input type="text" class="form-control" id="generoClub" placeholder="Ingrese el g√©nero literario del club" required>
                  </div>
                  <div class="form-group">
                      <label for="descripcionClub">Descripci√≥n</label>
                      <textarea class="form-control" id="descripcionClub" rows="3" placeholder="Ingrese una descripci√≥n del club" required></textarea>
                  </div>
                  <div class="form-group">
                      <label for="portadaClub">Portada</label>
                      <input type="file" class="form-control-file" id="portadaClub">
                  </div>
              </form>
            
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideModal('modalActualizarClub')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarClub()">Editar club</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Subir Libro -->
<div class="modal" id="modalSubirLibro" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Subir libro</h5>
              <button type="button" class="close" onclick="hideModal('modalSubirLibro')" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <form id="formSubirLibro">
                <div class="form-group">
                    <label for="tituloLibro">T√≠tulo del libro</label>
                    <input type="text" class="form-control" id="tituloLibro" placeholder="Ingrese el t√≠tulo del libro" required>
                </div>
                <div class="form-group">
                    <label for="autorLibro">Autor</label>
                    <input type="text" class="form-control" id="autorLibro" placeholder="Ingrese el autor del libro" required>
                </div>
                <div class="form-group">
                    <label for="descripcionLibro">Descripci√≥n</label>
                    <textarea class="form-control" id="descripcionLibro" rows="3" placeholder="Breve descripci√≥n del libro" required></textarea>
                </div>
                <div class="form-group">
                    <label for="fechaInicioLibro">Fecha de inicio</label>
                    <input type="date" class="form-control" id="fechaInicioLibro" required>
                </div>
                <div class="form-group">
                    <label for="fechaFinLibro">Fecha de fin</label>
                    <input type="date" class="form-control" id="fechaFinLibro" required>
                </div>
                <div class="form-group">
                    <label for="portadaLibro">Portada</label>
                    <input type="file" class="form-control-file" id="portadaLibro" accept="image/*" required>
                </div>
                <div class="form-group">
                  <label for="archivoLibro">Archivo del libro (Opcional)</label>
                  <input type="file" class="form-control-file" id="archivoLibro">
                  <small class="form-text text-muted">
                    * Readit no se hace responsable por la distribuci√≥n ilegal de libros compartidos por los usuarios.
                  </small>
                </div>
                
            </form>
          
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="hideModal('modalSubirLibro')">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btnSubirLibro">Subir libro</button>
          </div>
      </div>
  </div>
</div>


<!-- Modal Crear Evento -->
<div class="modal" id="modalCrearEvento" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-scrollable" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Crear evento</h5>
              <button type="button" class="close" onclick="hideModal('modalCrearEvento')" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          
          <!-- Agregamos un contenedor con scroll para evitar que el modal sea muy largo -->
          <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
              <form id="formCrearEvento">
                <div class="form-group">
                    <label for="nombreEvento">Nombre del evento</label>
                    <input type="text" class="form-control" id="nombreEvento" placeholder="Ingrese el nombre del evento" required>
                </div>
            
                <div class="form-group">
                    <label for="descripcionEvento">Descripci√≥n del evento</label>
                    <textarea class="form-control" id="descripcionEvento" rows="3" placeholder="Agregue una descripci√≥n del evento" required></textarea>
                </div>
            
                <div class="form-group">
                    <label for="fechaEvento">Fecha del evento</label>
                    <input type="date" class="form-control" id="fechaEvento" required>
                </div>
            
                <div class="form-group">
                    <label for="horaEvento">Hora del evento</label>
                    <input type="time" class="form-control" id="horaEvento" required>
                </div>
            
                <div class="form-group">
                    <label>Tipo de evento</label>
                    <div>
                        <input type="radio" id="virtual" name="tipoEvento" value="virtual" checked onclick="toggleLugar()" required>
                        <label for="virtual">Virtual</label>
            
                        <input type="radio" id="presencial" name="tipoEvento" value="presencial" onclick="toggleLugar()" required>
                        <label for="presencial">Presencial</label>
                    </div>
                </div>
            
                <div class="form-group">
                    <label id="labelLugar">Link a videollamada</label>
                    <input type="text" class="form-control" id="lugarEvento" placeholder="Ingrese el enlace a la videollamada" required>
                </div>
            
                <div class="form-group">
                    <label for="portadaEvento">Portada</label>
                    <input type="file" class="form-control-file" id="portadaEvento">
                </div>
            </form>
          
          </div>

          <!-- Fijar el footer para que siempre se vea -->
          <div class="modal-footer" style="position: sticky; bottom: 0; background: white; z-index: 10;">
              <button type="button" class="btn btn-secondary" onclick="hideModal('modalCrearEvento')">Cancelar</button>
              <button type="button" class="btn btn-primary" id="btnCrearEvento">Crear evento</button>
          </div>
      </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
</script>

<script>
document.getElementById('btnSubirLibro').addEventListener('click', async () => {
  const form = document.getElementById('formSubirLibro');
  if (!form.checkValidity()) {
    form.reportValidity(); // Muestra los mensajes nativos del navegador
    return;
  }

  const titulo = document.getElementById('tituloLibro').value;
  const autor = document.getElementById('autorLibro').value;
  const descripcion = document.getElementById('descripcionLibro').value;
  const fechaInicio = document.getElementById('fechaInicioLibro').value;
  const fechaFin = document.getElementById('fechaFinLibro').value;
  const portadaFile = document.getElementById('portadaLibro').files[0];
  const archivoFile = document.getElementById('archivoLibro').files[0];

  if (!titulo || !autor || !descripcion || !fechaInicio || !fechaFin) {
    Swal.fire({
      title: '¬°Campos incompletos!',
      text: 'Por favor, complete todos los campos obligatorios.',
      icon: 'warning',
      confirmButtonText: 'Cerrar'
    });
    return;
  }

  const formData = new FormData();
  formData.append('Libro', titulo);
  formData.append('Autor', autor);
  formData.append('descripcion', descripcion);
  formData.append('F_Inicio', fechaInicio);
  formData.append('F_Fin', fechaFin);
  if (portadaFile) {
    formData.append('portadaLibro', portadaFile);
  }
  if (archivoFile) {
    formData.append('archivoLibro', archivoFile);
  }
  // Append clubId to formData
  formData.append('clubId', club);

  try {
    const token = localStorage.getItem('jwtToken');
    const response = await fetch('http://localhost:3050/libros', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    });

    if (response.ok) {
      Swal.fire({
        title: '¬°√âxito!',
        text: 'Libro subido exitosamente.',
        icon: 'success',
        timer: 5000,
        willClose: () => location.reload()
      });
    } else {
      const errorData = await response.json();
      Swal.fire({
        title: '¬°Error!',
        text: 'Error al subir el libro: ' + (errorData.error || 'Error desconocido'),
        icon: 'error',
        confirmButtonText: 'Intentar de nuevo'
      });
    }
  } catch (error) {
    Swal.fire({
      title: '¬°Error!',
      text: 'Error al subir el libro: ' + error.message,
      icon: 'error',
      confirmButtonText: 'Intentar de nuevo'
    });
  }
});
</script>
<script>
document.getElementById('btnCrearEvento').addEventListener('click', () => {
  const form = document.getElementById('formCrearEvento');
  if (!form.checkValidity()) {
    form.reportValidity(); // Muestra mensajes nativos de validaci√≥n del navegador
    return;
  }
  const nombreEvento = document.getElementById('nombreEvento').value.trim();
  const descripcionEvento = document.getElementById('descripcionEvento').value.trim();
  const fechaEvento = document.getElementById('fechaEvento').value;
  const horaEvento = document.getElementById('horaEvento').value;
  const tipoEvento = document.querySelector('input[name="tipoEvento"]:checked').value;
  const lugarEvento = document.getElementById('lugarEvento').value.trim();
  const portadaEventoFile = document.getElementById('portadaEvento').files[0];

  if (!nombreEvento || !descripcionEvento || !fechaEvento || !horaEvento || !lugarEvento) {
    Swal.fire({
      title: '¬°Error!',
      text: 'Por favor, complete todos los campos obligatorios.',
      icon: 'error',
      confirmButtonText: 'Cerrar'
    });
    return;
  }

  if (portadaEventoFile) {
    const reader = new FileReader();
    reader.onload = async function(event) {
      const portadaBase64 = event.target.result;

      const eventoData = {
        Evento: nombreEvento,
        Descripcion: descripcionEvento,
        Fecha: fechaEvento,
        Hora: horaEvento,
        Tipo: tipoEvento === 'virtual' ? 'Virtual' : 'Presencial',
        info: lugarEvento,
        Portada: portadaBase64,
        clubId: club
      };

      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch('http://localhost:3050/eventos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventoData)
        });

        if (response.ok) {
          Swal.fire({
            title: '¬°√âxito!',
            text: 'Evento creado exitosamente',
            icon: 'success',
            timer: 5000,
            willClose: () => {
              hideModal('modalCrearEvento');
              location.reload();
            }
          });
        } else {
          const errorData = await response.json();
          Swal.fire({
            title: '¬°Error!',
            text: 'Error al crear el evento: ' + (errorData.error || 'Error desconocido'),
            icon: 'error',
            confirmButtonText: 'Intentar de nuevo'
          });
        }
      } catch (error) {
        Swal.fire({
          title: '¬°Error!',
          text: 'Error al crear el evento: ' + error.message,
          icon: 'error',
          confirmButtonText: 'Intentar de nuevo'
        });
      }
    };
    reader.readAsDataURL(portadaEventoFile);
  } else {
    const eventoData = {
      Evento: nombreEvento,
      Descripcion: descripcionEvento,
      Fecha: fechaEvento,
      Hora: horaEvento,
      Tipo: tipoEvento === 'virtual' ? 'Virtual' : 'Presencial',
      info: lugarEvento,
      clubId: club
    };

    (async () => {
      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch('http://localhost:3050/eventos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(eventoData)
        });

        if (response.ok) {
          Swal.fire({
            title: '¬°√âxito!',
            text: 'Evento creado exitosamente',
            icon: 'success',
            timer: 5000,
            willClose: () => {
              hideModal('modalCrearEvento');
              location.reload();
            }
          });
        } else {
          const errorData = await response.json();
          Swal.fire({
            title: '¬°Error!',
            text: 'Error al crear el evento: ' + (errorData.error || 'Error desconocido'),
            icon: 'error',
            confirmButtonText: 'Intentar de nuevo'
          });
        }
      } catch (error) {
        Swal.fire({
          title: '¬°Error!',
          text: 'Error al crear el evento: ' + error.message,
          icon: 'error',
          confirmButtonText: 'Intentar de nuevo'
        });
      }
    })();
  }
});
</script>
</body>
</html>

<script>
let notificationCount = 3; // N√∫mero inicial de notificaciones

    function updateNotificationBadge() {
        let badge = document.getElementById('notification-badge');
        if (notificationCount > 0) {
            badge.textContent = notificationCount;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }

    function toggleNotificationMenu() {
        let menu = document.getElementById('notification-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function markAsRead(event, element) {
        event.stopPropagation(); // Evita que el clic cierre el men√∫
        if (element.classList.contains('unread')) {
            element.classList.remove('unread');
            element.style.background = 'white'; // Quita el resaltado
            notificationCount--;
            updateNotificationBadge();
        }
    }

    // Llamar a la funci√≥n para asegurarse de que se muestre correctamente al cargar
    updateNotificationBadge();
</script>

<script>
  function toggleLugar() {
      let isVirtual = document.getElementById("virtual").checked;
      let labelLugar = document.getElementById("labelLugar");
      let inputLugar = document.getElementById("lugarEvento");

      if (isVirtual) {
          labelLugar.innerText = "Link a videollamada";
          inputLugar.placeholder = "Ingrese el enlace a la videollamada";
      } else {
          labelLugar.innerText = "Direcci√≥n del evento";
          inputLugar.placeholder = "Ingrese la direcci√≥n del evento";
      }
  }
</script>
<script>
  function toggleMembership(button) {
      let memberCountElement = document.getElementById("memberCount");
      let currentMembers = parseInt(memberCountElement.textContent);

      if (button.textContent === "Unirse al Club") {
          button.textContent = "Miembro del Club";
          button.classList.remove("btn-primary");
          button.classList.add("btn-success");
          memberCountElement.textContent = currentMembers + 1;
      } else {
          button.textContent = "Unirse al Club";
          button.classList.remove("btn-success");
          button.classList.add("btn-primary");
          memberCountElement.textContent = currentMembers - 1;
      }
  }
</script>
    
<script>
    let club = "";
    let clubActual = {}; // Guarda la informaci√≥n actual del club

    function fetchAndDisplayClub() {
        const params = new URLSearchParams(window.location.search);
        club = params.get("_id") || sessionStorage.getItem('selectedClub');

        if (club) {

            fetch(`http://localhost:3050/clubes/${encodeURIComponent(club)}`)
                .then(response => response.json())
                .then(club => {
                    clubActual = club;

                    // Update page elements
                    document.getElementById("NombreClub").textContent = club.NombreClub;
                    document.querySelector(".club-banner").src = club.Portada;
                    document.querySelector(".text-muted").textContent = club.Descripcion;
                    document.getElementById("admin").textContent = "Administrado por: " + club.Administrador;
                    document.getElementById("memberCount").textContent = club.Miembros;
                    document.getElementById("genero").textContent = club.Genero;

                    // Update form fields in edit modal
                    document.getElementById("nombreClub").value = club.NombreClub || "";
                    document.getElementById("descripcionClub").value = club.Descripcion || "";
                    document.getElementById("generoClub").value = club.Genero || "";

                    cargarLecturas(club.Lecturas_curso);
                    cargarEventos(club.Eventos);
                })
                .catch(error => console.error("Error al obtener los detalles del club:", error));
        }
    }

    document.addEventListener("DOMContentLoaded", fetchAndDisplayClub);

    function mostrarModalEditar() {
        document.getElementById("modalActualizarClub").style.display = "block";
    }

    function cerrarModalEditar() {
        document.getElementById("modalActualizarClub").style.display = "none";
    }

    function actualizarClub() {
      const form = document.getElementById('formActualizarClub');
      if (!form.checkValidity()) {
          form.reportValidity(); // Muestra los mensajes nativos de validaci√≥n
          return;
      }  
      const descripcion = document.getElementById("descripcionClub").value;
        const genero = document.getElementById("generoClub").value;
        const portadaInput = document.getElementById("portadaClub");

        if (portadaInput.files.length > 0) {
            const reader = new FileReader();
            reader.readAsDataURL(portadaInput.files[0]);
            reader.onload = function () {
                const portadaBase64 = reader.result; // Convertimos la imagen a Base64

                enviarActualizacion(descripcion, genero, portadaBase64);
            };
        } else {
            // Si no se seleccion√≥ nueva imagen, usamos la portada actual
            enviarActualizacion(descripcion, genero, clubActual.Portada);
        }
    }

    function enviarActualizacion(descripcion, genero, portada) {
        const clubActualizado = {
            "Descripcion": descripcion,
            "Genero": genero,
            "Portada": portada // Imagen en Base64 o la URL actual
        };

        fetch(`http://localhost:3050/clubes/${encodeURIComponent(club)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(clubActualizado)
        })
        .then(response => response.json())
        .then(data => {
            // Simulaci√≥n de √©xito de la solicitud
            Swal.fire({
                  title: '√âxito!',
                  text: 'Club actualizado exitosamente.',
                  icon: 'success',
                  timer: 4000, // Se cerrar√° autom√°ticamente despu√©s de 10 segundos
                  willClose: () => {  // Usamos 'willClose' para ejecutar c√≥digo antes de que se cierre
                      hideModal('modalActualizarClub');
                      // Aqu√≠ puedes recargar la p√°gina o hacer otras acciones
                      location.reload();
                  }
              });
              cerrarModalEditar(); // Aseg√∫rate de que esta funci√≥n no recargue la p√°gina
            })
        .catch(error => {
            console.error("Error al actualizar el club:", error);
          // En caso de error
          Swal.fire({
            title: 'Error!',
            text: 'Hubo un problema al actualizar el club.',
            icon: 'error',
            timer: 3000, // Se cerrar√° autom√°ticamente despu√©s de 2 segundos
            confirmButtonText: 'Intentar de nuevo'
          });        
        });
    }

    function cargarLecturas(lecturas) {
        let lecturasContainer = document.getElementById("libros");
        lecturasContainer.innerHTML = "";

        // Fetch all book details first
        Promise.all(lecturas.map(libro =>
            fetch(`http://localhost:3050/libros/${libro}`).then(response => response.json())
        )).then(librosData => {
            const now = new Date();

            // Separate books into in-progress and finished
            const inProgressBooks = librosData.filter(book => new Date(book.F_Fin) >= now);
            const finishedBooks = librosData.filter(book => new Date(book.F_Fin) < now);

            // Helper function to render books
            function renderBooks(books) {
                return books.map(data => `
                <div class="container mt-4" style="margin-bottom: 20px;">
                    <div class="row align-items-center book-card">
                        <div class="col-md-4">
                            <img class="img-fluid book-cover" src="${data.Portada}" alt="${data.Libro}">
                        </div>
                        <div class="col-md-8">
                            <h5>${data.Libro}</h5>
                            <p><strong>Autor:</strong> ${data.Autor}</p>
                            <p class="book-description">${data.descripcion}</p>
                            <p><strong>Inicio:</strong> ${data.F_Inicio}</p>
                            <p><strong>Fin:</strong> ${data.F_Fin}</p>
                            <button class="btn btn-primary btn-sm" onclick="goToDiscussion('${data._id}')">
                                <i class="fas fa-comments"></i> Ir a la discusi√≥n
                            </button>
                        </div>
                    </div>
                </div>`).join('');
            }

            // Render in-progress books section
            let html = '';
            if (inProgressBooks.length > 0) {
                html += '<h4>Libros en curso</h4>';
                html += renderBooks(inProgressBooks);
            }

            // Render finished books section
            if (finishedBooks.length > 0) {
                html += '<h4>Libros finalizados</h4>';
                html += renderBooks(finishedBooks);
            }

            lecturasContainer.innerHTML = html;
        });
    }

    function cargarEventos(eventos) {
        let eventosContainer = document.getElementById("eventos");
        eventosContainer.innerHTML = "";

        eventos.forEach(evento => {
          fetch(`http://localhost:3050/eventos/${evento}`)
            .then(response => response.json())
            .then(evento => {
            let eventoCard = `
                <div class="container mt-4">
                    <div class="row align-items-center event-card">
                        <div class="col-md-4">
                            <img class="img-fluid" src="${ evento.Portada }" alt="Portada del evento">
                        </div>
                        <div class="col-md-8">
                            <h5>${evento.Evento}</h5>
                            <p>${evento.Descripcion}</p>
                            <p><i class="far fa-calendar-alt"></i> ${evento.Fecha}, ${evento.Hora}</p>
                            <p><i class="fas fa-${evento.Tipo === 'Virtual' ? 'video' : 'map-marker-alt'}"></i> ${evento.Tipo}</p>
                            ${evento.Tipo === 'Virtual' ? '<p>Link de la llamada: <a href="'+evento.info+'">'+evento.info+'<a></p>' :
                            '<p>Direccion: '+evento.info+'</p>' }
                        </div>
                    </div>
                </div>`;
            eventosContainer.innerHTML += eventoCard;
            });
        });
    }
</script>

<!-- VOTACIONES DE Lecturas -->
<script>
    const barContainer = document.getElementById('barContainer');
    const voteButtons = document.getElementById('voteButtons');
    const mensajeVoto = document.getElementById('mensajeVoto');
  
    let currentVotacion = null;
    let userHasVoted = false;
  
    // Check if user has voted stored in localStorage by votacion ID
    function checkUserVoted(votacionId) {
      const voted = localStorage.getItem(`votoRealizado_${votacionId}`);
      return voted === 'true';
    }
  
    // Save user vote in localStorage
    function setUserVoted(votacionId) {
      localStorage.setItem(`votoRealizado_${votacionId}`, 'true');
    }
  
    // Render the votacion chart bars
    function renderChart() {
      barContainer.innerHTML = '';
      const totalVotos = currentVotacion.Libro.reduce((sum, libro) => sum + libro.votos, 0) || 1;
  
      currentVotacion.Libro.forEach(libro => {
        const porcentaje = (libro.votos / totalVotos) * 100;
  
        const bar = document.createElement('div');
        bar.className = 'bar';
  
        const barFill = document.createElement('div');
        barFill.className = 'bar-fill';
        barFill.style.width = porcentaje + '%';
        barFill.textContent = `${libro.name} ‚Äî ${libro.votos} voto(s)`;
  
        bar.appendChild(barFill);
        barContainer.appendChild(bar);
      });
    }
    function renderButtons() {
      voteButtons.innerHTML = '';
  
      if (userHasVoted) {
        mensajeVoto.textContent = 'Ya has votado. Gracias por participar.';
        return;
      }
  
      currentVotacion.Libro.forEach(libro => {
        const btn = document.createElement('button');
        btn.classList.add("votaciones");
        btn.textContent = `Votar por "${libro.name}"`;
        btn.onclick = async () => {
          try {
            const token = localStorage.getItem('jwtToken');
            const payloadBase64 = token.split('.')[1];
            const payloadJson = atob(payloadBase64);
            const user = JSON.parse(payloadJson);
            const userId = user.id;

            const response = await fetch(`http://localhost:3050/votaciones/${currentVotacion._id}/vote`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ tituloVotado: libro.name, id: userId })
            });
  
            if (response.ok) {
              const updatedVotacion = await response.json();
              currentVotacion = updatedVotacion;
              userHasVoted = true;
              setUserVoted(currentVotacion._id);
              mensajeVoto.textContent = `Gracias por votar por "${libro.name}"`;
              renderChart();
              renderButtons();
            } else {
              const errorData = await response.json();
              alert('Error al guardar el voto: ' + (errorData.error || 'Error desconocido'));
            }
          } catch (error) {
            alert('Error al guardar el voto: ' + error.message);
          }
        };
        voteButtons.appendChild(btn);
      });
    }
  
    // Fetch current votacion for the club and initialize UI
    async function fetchCurrentVotacion() {
      try {
        const token = localStorage.getItem('jwtToken');
        const response = await fetch(`http://localhost:3050/votaciones/club/${club}/current`);
  
        if (response.ok) {
          currentVotacion = await response.json();

          // Check if user has voted by calling the new API endpoint
          const userId = tokenData ? tokenData.id : null;
          if (userId && currentVotacion && currentVotacion._id) {
            const voteCheckResponse = await fetch(`http://localhost:3050/votaciones/${currentVotacion._id}/user/${userId}`);
            if (voteCheckResponse.ok) {
              const voteCheckData = await voteCheckResponse.json();
              userHasVoted = voteCheckData.hasVoted;
            } else {
              userHasVoted = false;
            }
          } else {
            userHasVoted = false;
          }

          renderChart();
          renderButtons();
        } else if (response.status === 404) {
          mensajeVoto.textContent = 'No hay votaci√≥n activa en este momento.';
          barContainer.innerHTML = '';
          voteButtons.innerHTML = '';
        } else {
          const errorData = await response.json();
          alert('Error al obtener la votaci√≥n: ' + (errorData.error || 'Error desconocido'));
        }
      } catch (error) {
        alert('Error al obtener la votaci√≥n: ' + error.message);
      }
    }
  
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      fetchCurrentVotacion();
    });
  </script>